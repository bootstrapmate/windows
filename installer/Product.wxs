<?xml version="1.0" encoding="UTF-8"?>

<!-- WiX v6 Installer XML for BootstrapMate Application -->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <?ifndef ProductVersion?>
    <?define ProductVersion = "0.0.0"?>
  <?endif?>
  <?ifndef CimianToolsVersion?>
    <?define CimianToolsVersion = "$(var.ProductVersion)"?>
  <?endif?>

  <!-- Package Definition -->
  <Package Name="BootstrapMate"
           Version="$(var.ProductVersion)"
           Manufacturer="Windows Admins Open Source"
           UpgradeCode="{87654321-4321-8765-CBA9-BA0987654321}"
           Language="1033"
           InstallerVersion="500"
           Compressed="yes"
           Scope="perMachine">

    <!-- Ensure silent installation by default -->
    <Property Id="MSIUSEREALADMINDETECTION" Value="1" />
    
    <!-- Major Upgrade Settings -->
    <MajorUpgrade AllowSameVersionUpgrades="no" 
                  AllowDowngrades="no"
                  MigrateFeatures="yes"
                  DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                  Schedule="afterInstallInitialize" />

    <!-- Media Definition -->
    <Media Id="1"
           Cabinet="bootstrapmate.cab"
           EmbedCab="yes" />

    <!-- Directory Structure -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLDIR" Name="BootstrapMate" />
    </StandardDirectory>

    <!-- Main Application Files -->
    <Component Id="BootstrapMateExecutable" Directory="INSTALLDIR" Guid="47855CCD-7EAB-464C-A795-26091DE8B83A">
      <File Id="BootstrapMateExe" Source="$(var.BIN_DIR)\installapplications.exe" />
    </Component>

    <!-- Runner Script -->
    <Component Id="BootstrapMateRunnerScript" Directory="INSTALLDIR" Guid="B8F7E6D5-C4A3-9012-B456-789012345CDE">
      <File Id="RunnerScript" Source="run.ps1" />
    </Component>

    <!-- Registry entries for installation tracking AND detection -->
    <Component Id="RegistryEntries" Directory="INSTALLDIR" Guid="E5F6A7B8-C9D0-1234-EF56-789012345ABC">
      <RegistryValue Root="HKLM" Key="SOFTWARE\BootstrapMate" Name="InstallPath" Value="[INSTALLDIR]" Type="string" />
      <RegistryValue Root="HKLM" Key="SOFTWARE\BootstrapMate" Name="Version" Value="$(var.ProductVersion)" Type="string" />
      <RegistryValue Root="HKLM" Key="SOFTWARE\BootstrapMate" Name="InstallDate" Value="[Date]" Type="string" />
      <RegistryValue Root="HKLM" Key="SOFTWARE\BootstrapMate" Name="Architecture" Value="[ProcessorArchitecture]" Type="string" />
    </Component>

    <!-- Bootstrap URL registry entries - only when URL is provided -->
    <Component Id="BootstrapRegistryEntries" Directory="INSTALLDIR" Guid="A1B2C3D4-E5F6-7890-1234-56789ABCDEF0"
               Condition="BOOTSTRAP_URL &lt;&gt; &quot;&quot;">
      <!-- Bootstrap URL for auto-execution -->
      <RegistryValue Root="HKLM" Key="SOFTWARE\BootstrapMate" Name="BootstrapUrl" Value="[BOOTSTRAP_URL]" Type="string" />
      <!-- Trigger flag for auto-execution -->
      <RegistryValue Root="HKLM" Key="SOFTWARE\BootstrapMate" Name="AutoRun" Value="1" Type="string" />
    </Component>

    <!-- Environment Variable Component -->
    <Component Id="SetPathComponent" Guid="D4E5F6A7-B8C9-0123-DEF4-56789012345A">
      <Environment Id="UpdatePath" Name="PATH" Value="[INSTALLDIR]" Permanent="no" Part="last" Action="set" Separator=";" System="yes" />
    </Component>
    
    <!-- Custom Properties for Bootstrap URL - Set via build parameter -->
    <Property Id="BOOTSTRAP_URL" Value="$(var.BootstrapUrl)" />
    
    <CustomAction Id="RunBootstrapMate" 
                  Directory="INSTALLDIR" 
                  ExeCommand="powershell.exe -WindowStyle Hidden -NoProfile -ExecutionPolicy Bypass -File &quot;[INSTALLDIR]run.ps1&quot;"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  HideTarget="yes" />

    <!-- Installation Sequences -->
    <InstallExecuteSequence>
      <!-- Primary: Direct execution after files are installed -->
      <Custom Action="RunBootstrapMate" After="InstallFiles" 
              Condition="BOOTSTRAP_URL &lt;&gt; &quot;&quot;" />
    </InstallExecuteSequence>

    <!-- Feature Definition -->
    <Feature Id="DefaultFeature" Level="1">
      <ComponentRef Id="BootstrapMateExecutable" />
      <ComponentRef Id="BootstrapMateRunnerScript" />
      <ComponentRef Id="RegistryEntries" />
      <ComponentRef Id="BootstrapRegistryEntries" />
      <ComponentRef Id="SetPathComponent" />
    </Feature>

  </Package>

</Wix>
